<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI-Powered NCR System</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 40px; background:#f5f7fa; }
    h1 { margin-bottom: 0; }
    .subtitle { color:#555; margin-top:4px; margin-bottom:20px; }
    .layout { display:flex; gap:32px; align-items:flex-start; }
    form, .panel { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.04); flex:1; }
    label { display:block; margin-top:10px; font-weight:600; font-size:14px; }
    input[type=text], textarea, select {
      width:100%; padding:8px 10px; margin-top:4px; border-radius:8px; border:1px solid #d0d7e2;
      font-size:14px; box-sizing:border-box; resize:vertical;
    }
    textarea { min-height:80px; }
    button {
      margin-top:16px; padding:10px 18px; border:none; border-radius:999px;
      background:#2563eb; color:#fff; font-weight:600; cursor:pointer; font-size:14px;
    }
    button:disabled { opacity:0.6; cursor:wait; }
    .chips { margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; }
    .chip { background:#e0ecff; color:#1d4ed8; padding:4px 10px; border-radius:999px; font-size:12px; }
    .ncr-list { margin-top:10px; max-height:260px; overflow:auto; font-size:13px; }
    .ncr-item { padding:8px 0; border-bottom:1px solid #e5e7eb; }
    .ncr-item-title { font-weight:600; }
    .ncr-item-meta { color:#6b7280; font-size:12px; }
  </style>
</head>
<body>
  <h1>AI-Powered NCR & Root Cause Analysis</h1>
  <div class="subtitle">Simple working demo for internship & job applications.</div>

  <div class="layout">
    <form id="ncrForm">
      <h2>Create NCR</h2>
      <label>Title
        <input type="text" name="title" required />
      </label>
      <label>Project
        <input type="text" name="project" required />
      </label>
      <label>Location
        <input type="text" name="location" required />
      </label>
      <label>Discipline
        <select name="discipline" required>
          <option value="civil">Civil</option>
          <option value="mechanical">Mechanical</option>
          <option value="electrical">Electrical</option>
          <option value="architectural">Architectural</option>
        </select>
      </label>
      <label>Severity
        <select name="severity" required>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </label>
      <label>Description
        <textarea name="description" required placeholder="Describe the non-conformance in detail..."></textarea>
      </label>
      <button type="submit">Submit NCR & Get AI Suggestion</button>
    </form>

    <div class="panel">
      <h2>AI Suggestions</h2>
      <div id="aiDefect" class="chips"></div>
      <div id="aiRootCause" style="margin-top:8px; font-size:14px;"></div>
      <div id="aiSimilar" style="margin-top:8px; font-size:12px; color:#6b7280;"></div>

      <h2 style="margin-top:24px;">Recent NCRs</h2>
      <div id="ncrList" class="ncr-list"></div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8000";

    async function fetchNcrs() {
      const res = await fetch(API_BASE + "/ncr");
      if (!res.ok) return;
      const data = await res.json();
      const list = document.getElementById("ncrList");
      list.innerHTML = "";
      data.forEach(ncr => {
        const div = document.createElement("div");
        div.className = "ncr-item";
        div.innerHTML = \`
          <div class="ncr-item-title">\${ncr.title}</div>
          <div class="ncr-item-meta">\${ncr.project} • \${ncr.location} • severity: \${ncr.severity}</div>
          <div class="ncr-item-meta">Root cause: \${ncr.root_cause || "pending analysis"}</div>
        \`;
        list.appendChild(div);
      });
    }

    document.getElementById("ncrForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector("button");
      btn.disabled = true;

      const payload = {
        title: form.title.value,
        project: form.project.value,
        location: form.location.value,
        discipline: form.discipline.value,
        severity: form.severity.value,
        description: form.description.value,
        photos: []
      };

      try {
        const res = await fetch(API_BASE + "/ncr", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const created = await res.json();

        const aiRes = await fetch(API_BASE + "/ai/suggestions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const ai = await aiRes.json();

        document.getElementById("aiDefect").innerHTML =
          '<span class="chip">' + (ai.defect_type || "N/A") + '</span>';
        document.getElementById("aiRootCause").textContent =
          ai.possible_root_cause || "";
        document.getElementById("aiSimilar").textContent =
          ai.similar_case_ids && ai.similar_case_ids.length
            ? "Similar cases: " + ai.similar_case_ids.join(", ")
            : "";

        await fetchNcrs();
        form.reset();
      } catch (err) {
        alert("Request failed: " + err);
      } finally {
        btn.disabled = false;
      }
    });

    fetchNcrs();
  </script>
</body>
</html>
